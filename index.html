<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cyclex Auswertung</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/x-icon" href="Bilder/Logo_Cyclex.png" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        background: linear-gradient(180deg, #f7f8fb 0%, #eef1f7 45%, #ffffff 100%);
        padding-top: 80px;
        color: #1f2a3d;
        scroll-behavior: smooth;
      }
      .navbar-custom {
        background-color: #7b0f1c;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18);
      }
      .navbar-custom .nav-link {
        color: #f7f7f7;
      }
      .navbar-custom .nav-link:hover {
        color: #ffffff;
      }
      .menu-btn {
        background-color: #f4f5f7;
        color: #1f2a3d;
        border: none;
        font-size: medium;
      }
      .dropdown-menu {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      .hero-banner {
        position: relative;
        overflow: hidden;
        min-height: 460px;
        background: linear-gradient(120deg, rgba(123, 15, 28, 0.78) 0%, rgba(159, 48, 66, 0.78) 60%, rgba(178, 71, 93, 0.78) 100%),
          url("blutzellen.jpg");
        background-size: cover;
        background-position: center;
        margin: 0 auto 3rem auto;
        width: 100%;
        box-shadow: 0 16px 38px rgba(0, 0, 0, 0.2);
      }
      .hero-wordmark {
        position: absolute;
        inset: 12% 5% auto auto;
        font-size: clamp(2.6rem, 9vw, 5.6rem);
        font-weight: 800;
        color: rgba(255, 255, 255, 0.12);
        letter-spacing: 0.18em;
        text-transform: uppercase;
      }
      .hero-title {
        font-size: clamp(2.3rem, 4vw, 3.4rem);
        font-weight: 800;
        letter-spacing: 0.01em;
      }
      .content-card {
        font-family: "Times New Roman", Times, serif;
        font-size: medium;
        text-align: center;
        border-radius: 14px;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
        background-color: #ffffff;
        border: 1px solid #f0f1f5;
      }
      .leiste {
        position: relative;
        width: 100%;
        height: 12px;
        background: linear-gradient(
          to right,
          darkred,
          #f6c343,
          lightgreen,
          #f6c343,
          darkred
        );
        margin: 10px auto;
        border-radius: 6px;
      }
      .marker {
        position: absolute;
        top: -6px;
        width: 4px;
        height: 24px;
        background-color: black;
        transition: left 0.2s ease;
      }
      input[type="number"] {
        width: 110px;
        padding: 4px;
        font-size: 1rem;
      }
      table thead td {
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-sm fixed-top navbar-custom">
      <div class="container-fluid">
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav w-100 flex-sm-row flex-column align-items-sm-center">
            <li class="nav-item col-sm-1 mb-2 mb-sm-0">
              <img
                src="Bilder/Logo_Cyclex.png"
                alt="LOGO"
                style="width: 50px; height: 50px; border-radius: 100%"
              />
            </li>
            <li class="col-md-8 text-center text-sm-start mb-2 mb-sm-0" style="color: whitesmoke">
              <h1 class="h3 mb-0">Cyclex</h1>
            </li>
            <li class="nav-item col-sm-2 p-2 text-center">
              <div class="dropdown">
                <button class="btn menu-btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  Menu
                </button>
                <ul class="dropdown-menu" style="font-size: medium">
                  <li>
                    <a class="nav-link" href="#rechner" style="color: black">Auswertung</a>
                  </li>
                  <li>
                    <a
                      class="nav-link"
                      href="Infoseite.html"
                      onclick="openProtectedLink(event, 'Infoseite.html')"
                      style="color: black"
                      >Weitere Infos</a
                    >
                  </li>
                  <li>
                    <a
                      class="nav-link"
                      href="Quellen.html"
                      onclick="openProtectedLink(event, 'Quellen.html')"
                      style="color: black"
                      >Quellen</a
                    >
                  </li>
                  <li>
                    <a
                      class="nav-link"
                      href="Impressum.html"
                      onclick="openProtectedLink(event, 'Impressum.html')"
                      style="color: black"
                      >Ueber uns & Impressum</a
                    >
                  </li>
                  <li>
                    <a
                      class="nav-link"
                      href="DSGVO.html"
                      onclick="openProtectedLink(event, 'DSGVO.html')"
                      style="color: black"
                      >DSGVO</a
                    >
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="pb-5">
      <section class="hero-banner">
        <div class="hero-wordmark">Cyclex</div>
        <div class="container-fluid h-100 px-4 px-md-5">
          <div class="row h-100 align-items-center gy-4">
            <div class="col-12 col-lg-7 text-light">
              <p class="text-uppercase small fw-semibold mb-2">Cyclex</p>
              <h1 class="hero-title mb-3">Gesundheit sichtbar machen.</h1>
              <p class="lead mb-4">
                Wir bereiten medizinische Inhalte verstaendlich auf und geben
                einen klaren Blick auf Blutwerte. Detaillierte Visualisierungen
                machen komplexe Themen leichter greifbar.
              </p>
              <a class="btn btn-light text-dark fw-semibold" href="#rechner">Zum Rechner</a>
            </div>
          </div>
        </div>
      </section>

      <section id="rechner" class="container p-4 content-card mb-4">
        <div class="col-lg-12">
          <h3>Geschlecht auswaehlen</h3>
          <label class="me-3">
            <input type="radio" name="geschlecht" value="m" id="mbutton" />
            Maennlich
          </label>
          <label>
            <input type="radio" name="geschlecht" id="wbutton" value="w" />
            Weiblich
          </label>
        </div>
        <div class="row">
          <div class="col-12">
            <table class="table align-middle mb-4" style="border-color: white">
              <thead>
                <td class="col-md-4">Wert</td>
                <td class="col-sm-1">Untergrenze</td>
                <td class="col-sm-1">Obergrenze</td>
                <td class="col-md-3">Ihr Wert</td>
                <td class="col-md-3">Skala</td>
              </thead>
              <tbody id="werte-tbody"></tbody>
            </table>
          </div>
        </div>
        <p class="text-muted mb-0 small">
          Bitte Geschlecht waehlen, Werte eintragen und Auswertung ansehen oder als PDF speichern.
        </p>
      </section>

      <div class="container" style="padding: 1rem">
        <div class="row align-items-center">
          <div class="col-md-4 mb-3">
            <button
              id="download-btn"
              class="btn btn-outline-dark w-100"
              type="button"
              style="font-size: medium; border-color: #7b0f1c; color: #7b0f1c"
            >
              Download PDF
            </button>
          </div>
          <div class="col-md-8">
            <canvas id="piechart" style="max-height: 280px"></canvas>
          </div>
        </div>
      </div>
    </main>

    <script>
      function openProtectedLink(event, targetpage) {
        event.preventDefault();

        const pw = prompt("Bitte Passwort eingeben:");

        if (pw === "cyclex123") {
          window.location.href = targetpage;
        } else {
          alert("Falsches Passwort!");
        }
      }

      const tests = [
        {
          id: "rbc",
          name: "Erythrozyten (RBC)",
          unit: "Mio/ul",
          range: { m: [4.5, 5.9], w: [4.1, 5.2] },
        },
        {
          id: "hb",
          name: "Haemoglobin (Hb)",
          unit: "g/dl",
          range: { m: [13, 17], w: [12, 16] },
        },
        {
          id: "hkt",
          name: "Haematokrit (Hkt)",
          unit: "%",
          range: { m: [42, 50], w: [37, 45] },
        },
        {
          id: "mcv",
          name: "MCV",
          unit: "fl",
          range: { m: [85, 98], w: [85, 98] },
        },
        {
          id: "mch",
          name: "MCH",
          unit: "pg",
          range: { m: [27, 34], w: [27, 34] },
        },
        {
          id: "mchc",
          name: "MCHC",
          unit: "g/dl",
          range: { m: [32, 36], w: [32, 36] },
        },
        {
          id: "leuko",
          name: "Leukozyten",
          unit: "/ul",
          range: { m: [4.000, 10.000], w: [4.000, 10.000] },
        },
        {
          id: "thrombo",
          name: "Thrombozyten",
          unit: "/ul",
          range: { m: [150.000, 380.000], w: [150.000, 380.000] },
        },
        {
          id: "reti",
          name: "Retikoluzyten",
          unit: "/ul",
          range: { m: [3, 18], w: [3, 18] },
        },
      ];

      const tbody = document.getElementById("werte-tbody");
      let pieChart;

      function getGeschlecht() {
        const checked = document.querySelector(
          'input[name="geschlecht"]:checked'
        );
        return checked ? checked.value : "m";
      }

      function formatRange(range) {
        return `${range[0]} - ${range[1]}`;
      }

      function renderRows() {
        tbody.innerHTML = "";
        tests.forEach((t) => {
          const tr = document.createElement("tr");

          const nameTd = document.createElement("td");
          nameTd.innerHTML = `${t.name}<br /><small>${t.unit}</small>`;

          const minTd = document.createElement("td");
          minTd.id = `${t.id}-min`;

          const maxTd = document.createElement("td");
          maxTd.id = `${t.id}-max`;

          const inputTd = document.createElement("td");
          const inp = document.createElement("input");
          inp.type = "number";
          inp.step = "0.1";
          inp.id = `${t.id}-input`;
          inputTd.appendChild(inp);

          const scaleTd = document.createElement("td");
          const bar = document.createElement("div");
          bar.className = "leiste";
          const marker = document.createElement("div");
          marker.className = "marker";
          marker.id = `${t.id}-marker`;
          bar.appendChild(marker);
          scaleTd.appendChild(bar);

          tr.appendChild(nameTd);
          tr.appendChild(minTd);
          tr.appendChild(maxTd);
          tr.appendChild(inputTd);
          tr.appendChild(scaleTd);

          tbody.appendChild(tr);
        });
      }

      function updateRanges() {
        const g = getGeschlecht();
        tests.forEach((t) => {
          const range = t.range[g];
          document.getElementById(`${t.id}-min`).innerText = range[0];
          document.getElementById(`${t.id}-max`).innerText = range[1];
        });
      }

      function statusForValue(val, range) {
        if (isNaN(val)) return null;
        if (val < range[0]) return "low";
        if (val > range[1]) return "high";
        return "normal";
      }

      function updateMarkers() {
        const g = getGeschlecht();
        tests.forEach((t) => {
          const range = t.range[g];
          const input = document.getElementById(`${t.id}-input`);
          const marker = document.getElementById(`${t.id}-marker`);
          const bar = marker.parentElement;

          const val = parseFloat(input.value);
          const status = statusForValue(val, range);

          let ratio;
          if (isNaN(val)) {
            ratio = 0.5;
          } else if (val <= range[0]) {
            ratio = 0;
          } else if (val >= range[1]) {
            ratio = 1;
          } else {
            ratio = (val - range[0]) / (range[1] - range[0]);
          }
          marker.style.left = `${ratio * bar.offsetWidth}px`;

          marker.style.backgroundColor =
            status === "high" ? "red" : status === "low" ? "blue" : "black";
        });
      }

      function buildChart() {
        const ctx = document.getElementById("piechart");
        pieChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["Zu hoch", "Im gruenen Bereich", "Zu niedrig"],
            datasets: [
              {
                backgroundColor: ["#d9534f", "#4caf50", "#0275d8"],
                data: [0, 0, 0],
              },
            ],
          },
          options: {
            plugins: {
              legend: { display: true, position: "bottom" },
              title: {
                display: true,
                text: "Deine Werte",
                font: { size: 16 },
              },
            },
          },
        });
      }

      function updateChart() {
        const g = getGeschlecht();
        let high = 0,
          normal = 0,
          low = 0;
        tests.forEach((t) => {
          const range = t.range[g];
          const val = parseFloat(
            document.getElementById(`${t.id}-input`).value
          );
          const status = statusForValue(val, range);
          if (status === "high") high++;
          else if (status === "low") low++;
          else if (status === "normal") normal++;
        });
        pieChart.data.datasets[0].data = [high, normal, low];
        pieChart.update();
      }

      function initInputs() {
        tests.forEach((t) => {
          const input = document.getElementById(`${t.id}-input`);
          input.addEventListener("input", () => {
            updateMarkers();
            updateChart();
          });
        });
      }

      function downloadPdf() {
        const g = getGeschlecht() === "m" ? "Maennlich" : "Weiblich";
        const bb =
          document.querySelector('input[name="blutbild"]:checked')?.value ===
          "g"
            ? "Grosses Blutbild"
            : "Kleines Blutbild";
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 15;
        doc.setFontSize(16);
        doc.text("Cyclex Blutwerte", 10, y);
        y += 8;
        doc.setFontSize(12);
        doc.text(`Geschlecht: ${g}`, 10, y);
        y += 6;
        doc.text(`Blutbild: ${bb}`, 10, y);
        y += 10;
        doc.setFontSize(11);
        doc.text("Wert (Einheit)", 10, y);
        doc.text("Referenz", 80, y);
        doc.text("Dein Wert", 130, y);
        doc.text("Status", 170, y);
        y += 5;
        doc.line(10, y, 200, y);
        y += 5;

        const gKey = getGeschlecht();
        tests.forEach((t) => {
          const range = t.range[gKey];
          const val = document.getElementById(`${t.id}-input`).value;
          const num = parseFloat(val);
          const status = statusForValue(num, range);
          const statusText =
            status === "high"
              ? "Zu hoch"
              : status === "low"
              ? "Zu niedrig"
              : status === "normal"
              ? "Im Normbereich"
              : "Kein Wert";

          if (y > 280) {
            doc.addPage();
            y = 20;
          }
          doc.text(`${t.name} (${t.unit})`, 10, y);
          doc.text(formatRange(range), 80, y);
          doc.text(val || "-", 130, y);
          doc.text(statusText, 170, y);
          y += 7;
        });

        const counts = pieChart.data.datasets[0].data;
        y += 5;
        doc.line(10, y, 200, y);
        y += 7;
        doc.text(
          `Zusammenfassung: Zu hoch ${counts[0]}, Normal ${counts[1]}, Zu niedrig ${counts[2]}`,
          10,
          y
        );

        doc.save("Cyclex-Blutwerte.pdf");
      }

      function setup() {
        renderRows();
        updateRanges();
        initInputs();
        buildChart();
        updateMarkers();
        updateChart();

        document.querySelectorAll('input[name="geschlecht"]').forEach((r) =>
          r.addEventListener("change", () => {
            updateRanges();
            updateMarkers();
            updateChart();
          })
        );

        document.querySelectorAll('input[name="blutbild"]').forEach((r) =>
          r.addEventListener("change", () => {
            updateMarkers();
            updateChart();
          })
        );

        document
          .getElementById("download-btn")
          .addEventListener("click", downloadPdf);
      }

      window.addEventListener("load", () => {
        if (!document.querySelector('input[name="geschlecht"]:checked')) {
          document.getElementById("mbutton").checked = true;
        }
        setup();
      });
    </script>
  </body>
</html>
